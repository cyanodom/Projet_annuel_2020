package steinerGraphJava.model;

import java.io.File;
import java.util.LinkedList;
import java.util.List;
import java.util.Observable;

import steinerGraphJava.algorithms.Genetique;
import steinerGraphJava.algorithms.population.PoidsPenality;
import steinerGraphJava.graph.Arc;
import steinerGraphJava.graph.Graph;
import steinerGraphJava.graph.GraphException;
import steinerGraphJava.graph.IGraph;
import steinerGraphJava.graph.graphFile.Translator;

public class SteinerModel extends Observable implements ISteinerModel {

	// ATTRIBUTS

	private File file;

	private Genetique gene;
	
	private Graph graph;
	
	private PoidsPenality res;
	
	private String fileLocation;
	
	private LinkedList<File> files;
	
	private boolean isSolved;


	// CONSTRUCTEUR

	public SteinerModel () {
		isSolved = false;
		files = new LinkedList<File>();
		graph = new Graph();
	}


	// COMMANDES

	public void runAlgo() {
		
		// ============ TEST ==============
		
		System.out.println("Nb Terminal : " + graph.getMaxTerminalNodeId());
		
		// System.out.println("Tous les Sommets :");
		// for (int i = 0; i < graph.getNodes().length; i++) {
		// 	System.out.println(graph.getNodes()[i].getName());
		// }

		// System.out.println();
		
		// System.out.println("Tous les sommets Terminaux :");
		for (int i = 0; i < graph.getMaxTerminalNodeId(); i++) {
			System.out.println(graph.getNodes()[i].getName());
		}
		
		// System.out.println();
		
		// System.out.println("Tous les Arcs :");
		// for (int i = 0; i < graph.getShape().size(); ++i) {
		// 	System.out.println("(" + graph.getShape().get(i).getNodes()[0].getName() + "," 
		// 						   + graph.getShape().get(i).getNodes()[1].getName() + ","
		// 						   + graph.getShape().get(i).getWeight() + ")");
		// }

		// ============ TEST ==============


		// PARTIE Genetique
		
		// True = elitiste / false = generationnel
		gene = new Genetique(graph, true);
		gene.algoGene();
		
		res = gene.getRes();
		
		
		// System.out.println("\nOn sort de l'algo génétique en ayant obtenue les valeurs : ");
		System.out.println("Les arcs restants sont : "+res.getArc().size());
		printArray(res.getArc());
		System.out.println("Poids " + ": " + res.getPoids());
		System.out.println("Penality : " + res.getPenality());
	}
	
	// OUTILS
	
	public void printArray(LinkedList<Arc> res) {
		for (int i = 0; i < res.size(); ++i) {
			System.out.println("(" + res.get(i).getNodes()[0].getName() + "," 
								   + res.get(i).getNodes()[1].getName() + ","
								   + res.get(i).getWeight() + ")");
		}
	}


	@Override
	public IGraph getGraph() {
		return graph;
	}


	@Override
	public void addFile(File selectedFile) throws GraphException {
		graph.makeUnionWith(Translator.trans(selectedFile));
		files.add(selectedFile);
	}


	@Override
	public List<String> getFileNames() {
		LinkedList<String> filesString = new LinkedList<String>();
		for (File f : files) {
			filesString.add(f.getName() + "\t\t" + f.getAbsolutePath());
		}
		return filesString;
	}


	@Override
	public void removeFileAtIndex(Integer correspondingIndex) {
		graph.makeRemove(Translator.trans(files.get(correspondingIndex)));
	}


	@Override
	public void saveFileTo(File selectedFile) {
		// TODO Auto-generated method stub
		
	}


	@Override
	public void undo() {
		// TODO Auto-generated method stub
		
	}


	@Override
	public void redo() {
		// TODO Auto-generated method stub
		
	}


	@Override
	public void emptyGraph() {
		graph.empty();
	}


	@Override
	public void addElement(String answer) throws GraphException {
		boolean isTerminal = false;
		if (answer.substring(0, 2) == "[T]") {
			isTerminal = true;
		}
		boolean arcMode = false;
		boolean thisIsSecondNode = false;
		String firstNode = "";
		String secondNode = "";
		
		for (int i = 0; i < answer.length(); ++i) {
			if (answer.charAt(i) == ' ' ) {
				if (answer.length() < i + 4 || answer.charAt(i + 1) != '-' 
						|| answer.charAt(i + 2) != ' ' || answer.charAt(i + 2) == ' ') {
					throw new GraphException("La syntaxe est invalide !");
				}
				i += 3;
				thisIsSecondNode = true;
				arcMode = true;
			} else {
				firstNode += answer.charAt(i);
			}
		}
		
	}


	@Override
	public void removeElement(String answer) {
		// TODO Auto-generated method stub
		
	}


	@Override
	public boolean checkNodeExist(String answerSource) {
		// TODO Auto-generated method stub
		return false;
	}


	@Override
	public void renameElement(String answerSource, String answerDest) {
		// TODO Auto-generated method stub
		
	}


	@Override
	public void solve() {
		isSolved = true;
		runAlgo();
	}


	@Override
	public void switchGraphToOriginal() {
		// TODO Auto-generated method stub
		
	}


	@Override
	public boolean canUndo() {
		// TODO Auto-generated method stub
		return false;
	}


	@Override
	public boolean canRedo() {
		// TODO Auto-generated method stub
		return false;
	}


	@Override
	public boolean isSolved() {
		return isSolved;
	}


	@Override
	public Integer getNbModification() {
		// TODO Auto-generated method stub
		return 0;
	}


	@Override
	public Integer getTimeToSolve() {
		// TODO Auto-generated method stub
		return null;
	}


	@Override
	public Integer getEfficiency() {
		// TODO Auto-generated method stub
		return null;
	}
}
